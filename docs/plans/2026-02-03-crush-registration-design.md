# å¥½ããªäººç™»éŒ²æ©Ÿèƒ½ è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2026-02-03
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆå®Œäº†ã€å®Ÿè£…å¾…ã¡

## æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¥½ããªäººã‚’ç™»éŒ²ã—ã€ç›¸æ‰‹ã‚‚è‡ªåˆ†ã‚’ç™»éŒ²ã—ã¦ã„ãŸå ´åˆã«è‡ªå‹•çš„ã«ãƒãƒƒãƒãƒ³ã‚°é€šçŸ¥ã‚’é€ã‚‹æ©Ÿèƒ½ã€‚

## ç¢ºå®šã—ãŸä»•æ§˜

### åŸºæœ¬æ–¹é‡
1. Webç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã§å¥½ããªäººã®åå‰ãƒ»èª•ç”Ÿæ—¥ã‚’å…¥åŠ›
2. ç›¸æ‰‹ã‚‚è‡ªåˆ†ã‚’ç™»éŒ²ã—ã¦ã„ãŸã‚‰è‡ªå‹•çš„ã«é€šçŸ¥
3. é€šçŸ¥ã¯LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç›¸æ‰‹ã®åå‰ã‚’å«ã‚ã‚‹
4. å†ç™»éŒ²æ©Ÿèƒ½ï¼ˆå¥½ããªäººã®å¤‰æ›´ï¼‰ã¯TODO

### åˆ¶ç´„æ¡ä»¶
- 1äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯1äººã ã‘å¥½ããªäººã‚’ç™»éŒ²å¯èƒ½ï¼ˆUNIQUEåˆ¶ç´„ï¼‰
- ãƒãƒƒãƒãƒ³ã‚°åˆ¤å®šã¯åå‰ã¨èª•ç”Ÿæ—¥ã®å®Œå…¨ä¸€è‡´
- è‡ªå·±ç™»éŒ²ã¯é˜²ãï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- å¥½ããªäººãŒæœªç™»éŒ²ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„ï¼ˆå¾Œã§ãƒãƒƒãƒãƒ³ã‚°å¯èƒ½ï¼‰

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLINE Botã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
2. Bot ãŒç™»éŒ²çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆRegistrationStep = 1ï¼Ÿï¼‰
3. ç™»éŒ²æ¸ˆã¿ãªã‚‰å¥½ããªäººç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ URLã‚’é€ä¿¡
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒWebãƒ•ã‚©ãƒ¼ãƒ ã§åå‰ãƒ»èª•ç”Ÿæ—¥ã‚’å…¥åŠ›
5. ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒƒãƒãƒ³ã‚°åˆ¤å®š
6. ãƒãƒƒãƒãƒ³ã‚°æ™‚ã¯ä¸¡æ–¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«LINEé€šçŸ¥

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

æ—¢å­˜ã®3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç¶­æŒï¼š

#### 1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤
- `static/crush/register.html` - å¥½ããªäººç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
- `static/crush/register.css` - ã‚¹ã‚¿ã‚¤ãƒ«
- `static/crush/register.js` - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

#### 2. APIå±¤ï¼ˆhandlerï¼‰
- `CrushRegistrationAPIHandler` æ–°è¦ä½œæˆ
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /api/register-crush`
- è²¬å‹™: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼ã€Serviceå‘¼ã³å‡ºã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

#### 3. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼ˆserviceï¼‰
- `UserService`ã«æ–°ãƒ¡ã‚½ãƒƒãƒ‰: `RegisterCrush(ctx, userID, crushName, crushBirthday) (matchedUserID string, error)`
- ãƒãƒƒãƒãƒ³ã‚°åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
- LINEé€šçŸ¥é€ä¿¡

#### 4. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆrepositoryï¼‰
- `LikeRepository` æ–°è¦ä½œæˆ
- ãƒ¡ã‚½ãƒƒãƒ‰: `Create`, `FindByFromUserID`, `FindMatchingLike`, `UpdateMatched`

#### 5. ã‚¤ãƒ³ãƒ•ãƒ©
- Nginx: `/crush/` ãƒ‘ã‚¹ã§ `static/crush/` ã‚’é…ä¿¡

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### å¥½ããªäººç™»éŒ²ãƒ•ãƒ­ãƒ¼
```
User â†’ Web Form â†’ POST /api/register-crush
  â†’ CrushRegistrationAPIHandler.RegisterCrush()
  â†’ UserService.RegisterCrush()
    â†’ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå·±ç™»éŒ²ãƒã‚§ãƒƒã‚¯ï¼‰
    â†’ LikeRepository.Create() (likesãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT)
    â†’ ãƒãƒƒãƒãƒ³ã‚°åˆ¤å®š
      â†’ UserRepository.FindByNameAndBirthday() (ç›¸æ‰‹ãŒusersã«å­˜åœ¨ï¼Ÿ)
      â†’ LikeRepository.FindMatchingLike() (ç›¸æ‰‹ã‚‚è‡ªåˆ†ã‚’ç™»éŒ²æ¸ˆã¿ï¼Ÿ)
      â†’ ãƒãƒƒãƒãƒ³ã‚°æ™‚:
        - ä¸¡æ–¹ã®like.matchedã‚’1ã«æ›´æ–°
        - ä¸¡æ–¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«LINEé€šçŸ¥
  â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´ { matched: bool, message: string }
```

### ãƒãƒƒãƒãƒ³ã‚°åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```go
// 1. å¥½ããªäººBãŒ users ãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
crushUser := userRepo.FindByNameAndBirthday(crushName, crushBirthday)
if crushUser == nil {
    // å­˜åœ¨ã—ãªã„ â†’ ãƒãƒƒãƒãƒ³ã‚°ä¸å¯ï¼ˆã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼‰
    return "", nil
}

// 2. Bã•ã‚“ãŒ Aã•ã‚“ï¼ˆè‡ªåˆ†ï¼‰ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã‹ç¢ºèª
reverseLike := likeRepo.FindMatchingLike(
    fromUserID: crushUser.LineID,
    toName: currentUser.Name,
    toBirthday: currentUser.Birthday
)

if reverseLike != nil {
    // ãƒãƒƒãƒãƒ³ã‚°æˆç«‹ï¼
    // ä¸¡æ–¹ã®likeãƒ¬ã‚³ãƒ¼ãƒ‰ã®matchedã‚’1ã«æ›´æ–°
    likeRepo.UpdateMatched(currentLike.ID, 1)
    likeRepo.UpdateMatched(reverseLike.ID, 1)

    // ä¸¡æ–¹ã«LINEé€šçŸ¥
    linebot.PushMessage(currentUser.LineID, "å±±ç”°å¤ªéƒã•ã‚“ã¨ãƒãƒƒãƒã—ã¾ã—ãŸï¼ğŸ’˜")
    linebot.PushMessage(crushUser.LineID, "ä½è—¤èŠ±å­ã•ã‚“ã¨ãƒãƒƒãƒã—ã¾ã—ãŸï¼ğŸ’˜")

    return crushUser.LineID, nil
}

return "", nil // ãƒãƒƒãƒãƒ³ã‚°ãªã—
```

## APIè¨­è¨ˆ

### POST /api/register-crush

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```json
{
  "user_id": "U1234567890",
  "crush_name": "å±±ç”°å¤ªéƒ",
  "crush_birthday": "1990-01-01"
}
```

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:**
- `user_id`: å¿…é ˆã€ç©ºæ–‡å­—ç¦æ­¢
- `crush_name`: å¿…é ˆã€1-50æ–‡å­—
- `crush_birthday`: å¿…é ˆã€YYYY-MM-DDå½¢å¼
- è‡ªå·±ç™»éŒ²ãƒã‚§ãƒƒã‚¯: `crush_name == user.Name && crush_birthday == user.Birthday` ãªã‚‰ã‚¨ãƒ©ãƒ¼

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰:**
```json
{
  "status": "ok",
  "matched": true,
  "message": "å±±ç”°å¤ªéƒã•ã‚“ã¨ãƒãƒƒãƒã—ã¾ã—ãŸï¼ğŸ’˜"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒãƒƒãƒãƒ³ã‚°ãªã—ï¼‰:**
```json
{
  "status": "ok",
  "matched": false,
  "message": "ç™»éŒ²ã—ã¾ã—ãŸã€‚ç›¸æ‰‹ãŒã‚ãªãŸã‚’ç™»éŒ²ã—ãŸã‚‰ãƒãƒƒãƒãƒ³ã‚°ã—ã¾ã™ã€‚"
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "error": "è‡ªåˆ†è‡ªèº«ã¯ç™»éŒ²ã§ãã¾ã›ã‚“"
}
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### likesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜ï¼‰

```sql
CREATE TABLE likes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  from_user_id TEXT NOT NULL,
  to_name TEXT NOT NULL,
  to_birthday TEXT NOT NULL,
  matched INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (from_user_id) REFERENCES users(line_user_id),
  UNIQUE(from_user_id)
);

CREATE INDEX idx_likes_to_name_birthday ON likes(to_name, to_birthday);
```

**å¤‰æ›´ä¸è¦** - æ—¢å­˜ã®ã‚¹ã‚­ãƒ¼ãƒã§å®Ÿè£…å¯èƒ½

### å¿…è¦ãªã‚¯ã‚¨ãƒª

1. **å¥½ããªäººã®ç™»éŒ²ï¼ˆINSERTï¼‰**
```sql
INSERT INTO likes (from_user_id, to_name, to_birthday)
VALUES (?, ?, ?)
ON CONFLICT(from_user_id) DO UPDATE SET
  to_name = excluded.to_name,
  to_birthday = excluded.to_birthday,
  matched = 0
```

2. **ãƒãƒƒãƒãƒ³ã‚°ç›¸æ‰‹ã®æ¤œç´¢ï¼ˆSELECTï¼‰**
```sql
SELECT * FROM likes
WHERE from_user_id = ?
  AND to_name = ?
  AND to_birthday = ?
```

3. **ãƒãƒƒãƒãƒ³ã‚°ãƒ•ãƒ©ã‚°æ›´æ–°ï¼ˆUPDATEï¼‰**
```sql
UPDATE likes SET matched = 1 WHERE id = ?
```

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

### HTMLæ§‹æˆ

`static/crush/register.html` ã¯ `static/liff/register.html` ã¨ã»ã¼åŒã˜æ§‹æˆï¼š
- ã‚¿ã‚¤ãƒˆãƒ«: ã€Œå¥½ããªäººç™»éŒ²ã€
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: åå‰ã€ç”Ÿå¹´æœˆæ—¥
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§åŸºæœ¬ãƒã‚§ãƒƒã‚¯
- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§`user_id`å–å¾—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£TODOï¼‰

### JavaScript

```javascript
async function registerCrush(name, birthday) {
    const userId = getUserIdFromURL();
    if (!userId) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    const response = await fetch('/api/register-crush', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            user_id: userId,
            crush_name: name,
            crush_birthday: birthday
        })
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    return data;
}
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
- è‡ªå·±ç™»éŒ²: ã€Œè‡ªåˆ†è‡ªèº«ã¯ç™»éŒ²ã§ãã¾ã›ã‚“ã€
- ç©ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ã€Œåå‰ã¨èª•ç”Ÿæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€
- ä¸æ­£ãªæ—¥ä»˜å½¢å¼: ã€Œæ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€

### ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼
- DBæ¥ç¶šã‚¨ãƒ©ãƒ¼: 500 Internal Server Error
- LINE API ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã«è¨˜éŒ²ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥æ¸ˆã¿ã¨è¡¨ç¤º

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
- å¥½ããªäººãŒæœªç™»éŒ²: ã‚¨ãƒ©ãƒ¼ã«ã›ãšã€ç™»éŒ²ã®ã¿å®Ÿè¡Œ
- ã™ã§ã«ç™»éŒ²æ¸ˆã¿: ä¸Šæ›¸ãï¼ˆTODO: å†ç™»éŒ²æ©Ÿèƒ½ã‚’å¾Œã§å®Ÿè£…ï¼‰
- åŒæ™‚ãƒãƒƒãƒãƒ³ã‚°: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦ï¼ˆSQLiteã®åˆ¶ç´„ã§è‡ªç„¶ã«è§£æ±ºï¼‰

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### æ—¢å­˜ã®å•é¡Œï¼ˆTODOï¼‰
- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§user_idã‚’å—ã‘å–ã‚‹ï¼ˆãªã‚Šã™ã¾ã—å¯èƒ½ï¼‰
- å°†æ¥çš„ã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³æ–¹å¼ã«å¤‰æ›´

### æ–°è¦ã®è€ƒæ…®ç‚¹
- è‡ªå·±ç™»éŒ²ã®é˜²æ­¢ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ï¼‰
- SQL injection: ãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆä½¿ç”¨
- XSS: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
1. `UserService.RegisterCrush()`
   - æ­£å¸¸ç³»: ãƒãƒƒãƒãƒ³ã‚°æˆç«‹
   - æ­£å¸¸ç³»: ãƒãƒƒãƒãƒ³ã‚°ãªã—ï¼ˆç›¸æ‰‹æœªç™»éŒ²ï¼‰
   - ç•°å¸¸ç³»: è‡ªå·±ç™»éŒ²ã‚¨ãƒ©ãƒ¼
   - ç•°å¸¸ç³»: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

2. `LikeRepository`
   - Create, FindByFromUserID, FindMatchingLike, UpdateMatched

### çµ±åˆãƒ†ã‚¹ãƒˆ
- ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ â†’ ãƒãƒƒãƒãƒ³ã‚° â†’ LINEé€šçŸ¥

## å®Ÿè£…ã®é †åº

1. Model: `Like` struct ä½œæˆ
2. Repository: `LikeRepository` å®Ÿè£…
3. Service: `UserService.RegisterCrush()` å®Ÿè£…
4. Handler: `CrushRegistrationAPIHandler` å®Ÿè£…
5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: HTML/CSS/JS
6. main.go: ãƒ«ãƒ¼ãƒˆè¿½åŠ 
7. Nginx: è¨­å®šè¿½åŠ 
8. ãƒ†ã‚¹ãƒˆ: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆ
9. ãƒ‡ãƒ—ãƒ­ã‚¤

## TODOï¼ˆå°†æ¥ã®æ”¹å–„ï¼‰

- [ ] å†ç™»éŒ²æ©Ÿèƒ½ï¼ˆå¥½ããªäººã®å¤‰æ›´ï¼‰
- [ ] ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³æ–¹å¼ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„
- [ ] ãƒãƒƒãƒãƒ³ã‚°å±¥æ­´ã®è¡¨ç¤º
- [ ] ãƒãƒƒãƒãƒ³ã‚°è§£é™¤æ©Ÿèƒ½
- [ ] è¤‡æ•°äººã®å¥½ããªäººç™»éŒ²ï¼ˆUNIQUEåˆ¶ç´„å‰Šé™¤ï¼‰

## å‚è€ƒ

- æ—¢å­˜å®Ÿè£…: `static/liff/register.html`, `internal/handler/registration_api.go`
- LINE Messaging API: Push Message
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: `db/migrations/20260117000001-initial_schema.sql`
